{% extends "layout.html" %}
{% block title %}لوحة التحكم{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">أهلاً بك، <span class="text-primary">{{ username }}</span>!</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-graduation-cap"></i> اختبارات قياس المتاحة</h4>
                </div>
                <div class="card-body">
                    {% if tests_qiyas_by_level %}
                        {% for level, tests in tests_qiyas_by_level.items()|sort %}
                            <h5 class="mb-3">المرحلة {{ level }}</h5>
                            <ul class="list-group list-group-flush">
                                {% for test in tests %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ test.name }}
                                        <a href="{{ url_for('take_test', test_id=test.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-play-circle"></i> ابدأ الاختبار
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                            {% if not loop.last %}<hr class="my-3">{% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted">لا توجد اختبارات قياس متاحة حالياً.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-book-open"></i> اختبارات تحصيلي المتاحة</h4>
                </div>
                <div class="card-body">
                    {% if tests_tahseli_by_level %}
                         {% for level, tests in tests_tahseli_by_level.items()|sort %}
                            <h5 class="mb-3">المرحلة {{ level }}</h5>
                            <ul class="list-group list-group-flush">
                                {% for test in tests %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ test.name }}
                                        <a href="{{ url_for('take_test', test_id=test.id) }}" class="btn btn-sm btn-outline-success">
                                            <i class="fas fa-play-circle"></i> ابدأ الاختبار
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                             {% if not loop.last %}<hr class="my-3">{% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted">لا توجد اختبارات تحصيلي متاحة حالياً.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h4 class="mb-0"><i class="fas fa-history"></i> سجل النتائج السابقة</h4>
        </div>
        <div class="card-body">
            {% if past_results %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>اسم الاختبار</th>
                                <th>النتيجة</th>
                                <th>النسبة المئوية</th>
                                <th>التاريخ والوقت</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in past_results %}
                            <tr>
                                <td>{{ result.test_name }}</td>
                                <td>{{ result.score }} / {{ result.total_questions }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if result.percentage >= 80 %}bg-success{% elif result.percentage >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                                             role="progressbar" style="width: {{ result.percentage }}%;"
                                             aria-valuenow="{{ result.percentage }}" aria-valuemin="0" aria-valuemax="100">
                                             {{ result.percentage }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ result.timestamp | format_datetime }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center text-muted">لم تقم بإجراء أي اختبارات بعد.</p>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mt-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0"><i class="fas fa-exclamation-triangle"></i> مساعدة بخصوص الحساب</h4>
        </div>
        <div class="card-body">
            <p>
                <strong>هل نسيت كلمة المرور أو ترغب في حذف حسابك؟</strong>
            </p>
            <p>
                نظراً لعدم توفر خاصية "استعادة كلمة المرور" حالياً، إذا واجهت مشكلة في الدخول لحسابك أو أردت حذفه لأي سبب، يرجى التواصل مع الإدارة مباشرة لطلب حذف الحساب. بعد الحذف، يمكنك التسجيل من جديد بنفس البريد الإلكتروني إذا أردت.
            </p>
            <div class="alert alert-info">
                <strong>للتواصل مع الإدارة لطلب حذف الحساب:</strong><br>
                يرجى إرسال بريد إلكتروني إلى: <a href="mailto:admin@yourdomain.com">admin@yourdomain.com</a>
                <br>
                <em>(ملاحظة: تأكد من ذكر اسم المستخدم الخاص بك في البريد الإلكتروني لتسهيل عملية الحذف.)</em>
            </div>
             <p class="text-muted small">
                نعتذر عن الإزعاج، ونعمل على إضافة خاصية استعادة كلمة المرور في التحديثات القادمة.
            </p>
        </div>
    </div>

</div>
{% endblock %}